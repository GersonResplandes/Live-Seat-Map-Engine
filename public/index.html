<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Seat Map Engine</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #222; color: #fff; display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; }
        h1 { margin-top: 20px; text-transform: uppercase; letter-spacing: 2px; }
        .screen { width: 300px; height: 10px; background: #fff; margin: 20px 0; border-radius: 5px; box-shadow: 0 0 20px rgba(255,255,255,0.2); }
        .legend { display: flex; gap: 20px; margin-bottom: 20px; }
        .legend div { display: flex; align-items: center; gap: 5px; }
        .seat.sample { width: 20px; height: 20px; cursor: default; }

        .cinema-container {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 10px;
            background: #333;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .seat {
            width: 40px;
            height: 40px;
            background: #4CAF50; /* Green - Available */
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            color: rgba(255,255,255,0.7);
        }

        .seat:hover:not(.locked):not(.my-seat) {
            transform: scale(1.1);
            background: #66BB6A;
        }

        .seat.locked {
            background: #EF5350; /* Red - Locked */
            cursor: not-allowed;
            pointer-events: none;
        }

        .seat.my-seat {
            background: #FFA726; /* Orange - My Selection */
            box-shadow: 0 0 10px #FFA726;
        }

        #status { margin-top: 20px; height: 20px; color: #aaa; }
    </style>
</head>
<body>

    <h1>Live Cinema</h1>
    <div class="screen"></div>
    
    <div class="legend">
        <div><div class="seat sample" style="background: #4CAF50"></div> Livre</div>
        <div><div class="seat sample" style="background: #FFA726"></div> Seu</div>
        <div><div class="seat sample" style="background: #EF5350"></div> Ocupado</div>
    </div>

    <div class="cinema-container" id="grid">
        <!-- Seats generated by JS -->
    </div>

    <div id="status">Conectando...</div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // --- 1. Initialize Socket ---
        const socket = io({
            auth: {
                token: "guest_token_123" // Simulating a token
            }
        });
        const grid = document.getElementById('grid');
        const statusDiv = document.getElementById('status');
        
        // User ID will be assigned by server (Security Phase 1)
        let userId = null; 

        // --- 2. Generate Grid (10x10) ---
        const rows = ['A','B','C','D','E','F','G','H','I','J'];
        const seats = [];

        rows.forEach(row => {
            for (let i = 1; i <= 10; i++) {
                const seatId = `${row}${i}`;
                const seatDiv = document.createElement('div');
                seatDiv.className = 'seat';
                seatDiv.id = `seat-${seatId}`;
                seatDiv.innerText = seatId;
                
                seatDiv.onclick = () => toggleSeat(seatId);
                
                grid.appendChild(seatDiv);
            }
        });

        // --- 3. Interaction Logic ---
        function toggleSeat(seatId) {
            const el = document.getElementById(`seat-${seatId}`);
            if (el.classList.contains('locked') && !el.classList.contains('my-seat')) return;

            if (el.classList.contains('my-seat')) {
                // Release
                socket.emit('release_seat', { seatId, userId });
                // Optimistic UI update (will be confirmed by server, but feels faster)
                // Actually, let's wait for server confirmation to be 100% accurate or just handle local state?
                // For this demo, we'll wait for events to keep it strictly event-driven.
            } else {
                // Request Lock
                socket.emit('request_seat', { seatId, userId });
            }
        }

        // --- 4. Socket Events ---
        
        socket.on('connect', () => {
            // Ask server who I am
            socket.emit('whoami');
            socket.emit('join_room', 'cinema_1');
        });

        socket.on('your_identity', (id) => {
            userId = id;
            statusDiv.innerText = `Conectado como ${userId}`;
        });

        socket.on('disconnect', () => {
            statusDiv.innerText = 'Desconectado';
        });

        // Initial State
        socket.on('current_state', (lockedSeats) => {
            lockedSeats.forEach(({ seatId, userId: ownerId }) => {
                updateSeatVisuals(seatId, ownerId);
            });
        });

        // Real-time Update: Locked
        socket.on('seat_locked', ({ seatId, userId: ownerId }) => {
            updateSeatVisuals(seatId, ownerId);
        });

        // Real-time Update: Released
        socket.on('seat_released', ({ seatId }) => {
            const el = document.getElementById(`seat-${seatId}`);
            if (el) {
                el.className = 'seat'; // Reset to green
            }
        });

        socket.on('error', (err) => {
            alert(err.message);
        });

        function updateSeatVisuals(seatId, ownerId) {
            const el = document.getElementById(`seat-${seatId}`);
            if (!el) return;

            if (ownerId === userId) {
                el.className = 'seat my-seat';
            } else {
                el.className = 'seat locked';
            }
        }
    </script>
</body>
</html>
